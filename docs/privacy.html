<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Ethique: Privacy</title>




  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Ethique: Privacy"/>
  <meta property="og:type" content="article"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="Ethique"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Ethique: Privacy"/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","site","jupyter"]}},"value":[{"type":"character","attributes":{},"value":["Privacy"]},{"type":"character","attributes":{},"value":["distill::distill_website"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["jupytext","kernelspec"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["formats","text_representation"]}},"value":[{"type":"character","attributes":{},"value":["ipynb,Rmd"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["extension","format_name","format_version","jupytext_version"]}},"value":[{"type":"character","attributes":{},"value":[".Rmd"]},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"character","attributes":{},"value":["1.2"]},{"type":"character","attributes":{},"value":["1.11.4"]}]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["display_name","language","name"]}},"value":[{"type":"character","attributes":{},"value":["Python 3"]},{"type":"character","attributes":{},"value":["python"]},{"type":"character","attributes":{},"value":["python3"]}]}]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  <!--radix_placeholder_navigation_in_header-->
  <meta name="distill:offset" content=""/>

  <script type="application/javascript">

    window.headroom_prevent_pin = false;

    window.document.addEventListener("DOMContentLoaded", function (event) {

      // initialize headroom for banner
      var header = $('header').get(0);
      var headerHeight = header.offsetHeight;
      var headroom = new Headroom(header, {
        tolerance: 5,
        onPin : function() {
          if (window.headroom_prevent_pin) {
            window.headroom_prevent_pin = false;
            headroom.unpin();
          }
        }
      });
      headroom.init();
      if(window.location.hash)
        headroom.unpin();
      $(header).addClass('headroom--transition');

      // offset scroll location for banner on hash change
      // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
      window.addEventListener("hashchange", function(event) {
        window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
      });

      // responsive menu
      $('.distill-site-header').each(function(i, val) {
        var topnav = $(this);
        var toggle = topnav.find('.nav-toggle');
        toggle.on('click', function() {
          topnav.toggleClass('responsive');
        });
      });

      // nav dropdowns
      $('.nav-dropbtn').click(function(e) {
        $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
        $(this).parent().siblings('.nav-dropdown')
           .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $("body").click(function(e){
        $('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $(".nav-dropdown").click(function(e){
        e.stopPropagation();
      });
    });
  </script>

  <style type="text/css">

  /* Theme (user-documented overrideables for nav appearance) */

  .distill-site-nav {
    color: rgba(255, 255, 255, 0.8);
    background-color: #0F2E3D;
    font-size: 15px;
    font-weight: 300;
  }

  .distill-site-nav a {
    color: inherit;
    text-decoration: none;
  }

  .distill-site-nav a:hover {
    color: white;
  }

  @media print {
    .distill-site-nav {
      display: none;
    }
  }

  .distill-site-header {

  }

  .distill-site-footer {

  }


  /* Site Header */

  .distill-site-header {
    width: 100%;
    box-sizing: border-box;
    z-index: 3;
  }

  .distill-site-header .nav-left {
    display: inline-block;
    margin-left: 8px;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header .nav-left {
      margin-left: 0;
    }
  }


  .distill-site-header .nav-right {
    float: right;
    margin-right: 8px;
  }

  .distill-site-header a,
  .distill-site-header .title {
    display: inline-block;
    text-align: center;
    padding: 14px 10px 14px 10px;
  }

  .distill-site-header .title {
    font-size: 18px;
    min-width: 150px;
  }

  .distill-site-header .logo {
    padding: 0;
  }

  .distill-site-header .logo img {
    display: none;
    max-height: 20px;
    width: auto;
    margin-bottom: -4px;
  }

  .distill-site-header .nav-image img {
    max-height: 18px;
    width: auto;
    display: inline-block;
    margin-bottom: -3px;
  }



  @media screen and (min-width: 1000px) {
    .distill-site-header .logo img {
      display: inline-block;
    }
    .distill-site-header .nav-left {
      margin-left: 20px;
    }
    .distill-site-header .nav-right {
      margin-right: 20px;
    }
    .distill-site-header .title {
      padding-left: 12px;
    }
  }


  .distill-site-header .nav-toggle {
    display: none;
  }

  .nav-dropdown {
    display: inline-block;
    position: relative;
  }

  .nav-dropdown .nav-dropbtn {
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 16px 10px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    margin: 0;
    margin-top: 1px;
    z-index: 2;
  }

  .nav-dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
    z-index: 1;
    margin-top: 2px;
    white-space: nowrap;
    padding-top: 4px;
    padding-bottom: 4px;
  }

  .nav-dropdown-content hr {
    margin-top: 4px;
    margin-bottom: 4px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .nav-dropdown-active {
    display: block;
  }

  .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
    color: black;
    padding: 6px 24px;
    text-decoration: none;
    display: block;
    text-align: left;
  }

  .nav-dropdown-content .nav-dropdown-header {
    display: block;
    padding: 5px 24px;
    padding-bottom: 0;
    text-transform: uppercase;
    font-size: 14px;
    color: #999999;
    white-space: nowrap;
  }

  .nav-dropdown:hover .nav-dropbtn {
    color: white;
  }

  .nav-dropdown-content a:hover {
    background-color: #ddd;
    color: black;
  }

  .nav-right .nav-dropdown-content {
    margin-left: -45%;
    right: 0;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
    .distill-site-header a.nav-toggle {
      float: right;
      display: block;
    }
    .distill-site-header .title {
      margin-left: 0;
    }
    .distill-site-header .nav-right {
      margin-right: 0;
    }
    .distill-site-header {
      overflow: hidden;
    }
    .nav-right .nav-dropdown-content {
      margin-left: 0;
    }
  }


  @media screen and (max-width: 768px) {
    .distill-site-header.responsive {position: relative; min-height: 500px; }
    .distill-site-header.responsive a.nav-toggle {
      position: absolute;
      right: 0;
      top: 0;
    }
    .distill-site-header.responsive a,
    .distill-site-header.responsive .nav-dropdown {
      display: block;
      text-align: left;
    }
    .distill-site-header.responsive .nav-left,
    .distill-site-header.responsive .nav-right {
      width: 100%;
    }
    .distill-site-header.responsive .nav-dropdown {float: none;}
    .distill-site-header.responsive .nav-dropdown-content {position: relative;}
    .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
      display: block;
      width: 100%;
      text-align: left;
    }
  }

  /* Site Footer */

  .distill-site-footer {
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    z-index: 3;
    margin-top: 30px;
    padding-top: 30px;
    padding-bottom: 30px;
    text-align: center;
  }

  /* Headroom */

  d-title {
    padding-top: 6rem;
  }

  @media print {
    d-title {
      padding-top: 4rem;
    }
  }

  .headroom {
    z-index: 1000;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }

  .headroom--transition {
    transition: all .4s ease-in-out;
  }

  .headroom--unpinned {
    top: -100px;
  }

  .headroom--pinned {
    top: 0;
  }

  /* adjust viewport for navbar height */
  /* helps vertically center bootstrap (non-distill) content */
  .min-vh-100 {
    min-height: calc(100vh - 100px) !important;
  }

  </style>

  <script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
  <link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
  <link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
  <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
  <script src="site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
  <script src="site_libs/fuse-6.4.1/fuse.min.js"></script>

  <script type="application/javascript">

  function getMeta(metaName) {
    var metas = document.getElementsByTagName('meta');
    for (let i = 0; i < metas.length; i++) {
      if (metas[i].getAttribute('name') === metaName) {
        return metas[i].getAttribute('content');
      }
    }
    return '';
  }

  function offsetURL(url) {
    var offset = getMeta('distill:offset');
    return offset ? offset + '/' + url : url;
  }

  function createFuseIndex() {

    // create fuse index
    var options = {
      keys: [
        { name: 'title', weight: 20 },
        { name: 'categories', weight: 15 },
        { name: 'description', weight: 10 },
        { name: 'contents', weight: 5 },
      ],
      ignoreLocation: true,
      threshold: 0
    };
    var fuse = new window.Fuse([], options);

    // fetch the main search.json
    return fetch(offsetURL('search.json'))
      .then(function(response) {
        if (response.status == 200) {
          return response.json().then(function(json) {
            // index main articles
            json.articles.forEach(function(article) {
              fuse.add(article);
            });
            // download collections and index their articles
            return Promise.all(json.collections.map(function(collection) {
              return fetch(offsetURL(collection)).then(function(response) {
                if (response.status === 200) {
                  return response.json().then(function(articles) {
                    articles.forEach(function(article) {
                      fuse.add(article);
                    });
                  })
                } else {
                  return Promise.reject(
                    new Error('Unexpected status from search index request: ' +
                              response.status)
                  );
                }
              });
            })).then(function() {
              return fuse;
            });
          });

        } else {
          return Promise.reject(
            new Error('Unexpected status from search index request: ' +
                        response.status)
          );
        }
      });
  }

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // get search element (bail if we don't have one)
    var searchEl = window.document.getElementById('distill-search');
    if (!searchEl)
      return;

    createFuseIndex()
      .then(function(fuse) {

        // make search box visible
        searchEl.classList.remove('hidden');

        // initialize autocomplete
        var options = {
          autoselect: true,
          hint: false,
          minLength: 2,
        };
        window.autocomplete(searchEl, options, [{
          source: function(query, callback) {
            const searchOptions = {
              isCaseSensitive: false,
              shouldSort: true,
              minMatchCharLength: 2,
              limit: 10,
            };
            var results = fuse.search(query, searchOptions);
            callback(results
              .map(function(result) { return result.item; })
            );
          },
          templates: {
            suggestion: function(suggestion) {
              var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
                ? `<img src="${offsetURL(suggestion.preview)}"</img>`
                : '';
              var html = `
                <div class="search-item">
                  <h3>${suggestion.title}</h3>
                  <div class="search-item-description">
                    ${suggestion.description || ''}
                  </div>
                  <div class="search-item-preview">
                    ${img}
                  </div>
                </div>
              `;
              return html;
            }
          }
        }]).on('autocomplete:selected', function(event, suggestion) {
          window.location.href = offsetURL(suggestion.path);
        });
        // remove inline display style on autocompleter (we want to
        // manage responsive display via css)
        $('.algolia-autocomplete').css("display", "");
      })
      .catch(function(error) {
        console.log(error);
      });

  });

  </script>

  <style type="text/css">

  .nav-search {
    font-size: x-small;
  }

  /* Algolioa Autocomplete */

  .algolia-autocomplete {
    display: inline-block;
    margin-left: 10px;
    vertical-align: sub;
    background-color: white;
    color: black;
    padding: 6px;
    padding-top: 8px;
    padding-bottom: 0;
    border-radius: 6px;
    border: 1px #0F2E3D solid;
    width: 180px;
  }


  @media screen and (max-width: 768px) {
    .distill-site-nav .algolia-autocomplete {
      display: none;
      visibility: hidden;
    }
    .distill-site-nav.responsive .algolia-autocomplete {
      display: inline-block;
      visibility: visible;
    }
    .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
      margin-left: 0;
      width: 400px;
      max-height: 400px;
    }
  }

  .algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
    width: 90%;
    outline: none;
    border: none;
  }

  .algolia-autocomplete .aa-hint {
    color: #999;
  }
  .algolia-autocomplete .aa-dropdown-menu {
    width: 550px;
    max-height: 70vh;
    overflow-x: visible;
    overflow-y: scroll;
    padding: 5px;
    margin-top: 3px;
    margin-left: -150px;
    background-color: #fff;
    border-radius: 5px;
    border: 1px solid #999;
    border-top: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
    cursor: pointer;
    padding: 5px 4px;
    border-bottom: 1px solid #eee;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
    border-bottom: none;
    margin-bottom: 2px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
    overflow: hidden;
    font-size: 0.8em;
    line-height: 1.4em;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
    font-size: 1rem;
    margin-block-start: 0;
    margin-block-end: 5px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
    display: inline-block;
    overflow: hidden;
    height: 2.8em;
    width: 80%;
    margin-right: 4%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
    display: inline-block;
    width: 15%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
    height: 3em;
    width: auto;
    display: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
    display: initial;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
    background-color: #eee;
  }
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
    font-weight: bold;
    font-style: normal;
  }

  </style>


  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="site_libs/header-attrs-2.7/header-attrs.js"></script>
  <script src="site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Privacy","authors":[]}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="index.html" class="title">Ethique</a>
</div>
<div class="nav-right">
<a href="index.html">Home</a>
<a href="about.html">About</a>
<a href="privacy.html">Privacy</a>
<a href="fairness.html">Fairness</a>
<a href="https://github.com/PayjPan/Ethique" aria-label="Link to source">
<i class="fab fa-github" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Privacy</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->

</div>


<div class="d-article">
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/rstudio/reticulate'>reticulate</a></span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/reticulate/man/use_python.html'>use_condaenv</a></span><span class='op'>(</span><span class='st'>'ethique_env'</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h1 id="privacy-et-robusness">Privacy et Robusness</h1>
<p>Dans ce notebook je vais présenter les différentes attaques présentées dans la trousse à outils d’IMB <em>Adversarial Robusteness 360</em> :</p>
<ul>
<li>Evasion</li>
<li>Poisoning</li>
<li>Inference and Inversion</li>
<li>Model Extraction</li>
</ul>
<p>Pour illustrer ces différentes attaques nous allons utilisé la base de données :</p>
<ul>
<li>German Credit (lien)</li>
</ul>
<p>Le modèle que nous allons attaquer est une régression logisitique en utilisant la librairie <em>scikit learn</em></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.notebook <span class="im">import</span> tqdm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product, combinations</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> copy <span class="im">import</span> deepcopy</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> model_selection</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, FunctionTransformer</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression, LinearRegression</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, confusion_matrix, plot_confusion_matrix</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">&#39;darkgrid&#39;</span>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>seed <span class="op">=</span> <span class="dv">2021</span></span></code></pre></div>
</div>
<h2 id="prépration-des-données-et-création-du-modèle-cible">Prépration des données et création du modèle cible</h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>credit <span class="op">=</span> pd.read_csv(<span class="st">&quot;data/german_credit_prepared.csv&quot;</span>, sep<span class="op">=</span><span class="st">&quot;,&quot;</span>, engine<span class="op">=</span><span class="st">&quot;python&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> credit[<span class="st">&#39;default&#39;</span>]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> credit.drop(columns<span class="op">=</span><span class="st">&quot;default&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Définie quelles colones sont categorielles et quelles sont continue</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>variables_cat <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> X.columns <span class="cf">if</span> credit[col].dtype<span class="op">==</span><span class="bu">object</span>]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>variables_ord <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> X.columns <span class="cf">if</span> credit[col].dtype<span class="op">==</span><span class="bu">int</span>]</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>preprocess <span class="op">=</span> ColumnTransformer(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;cat&#39;</span>, OneHotEncoder(drop<span class="op">=</span><span class="st">&#39;first&#39;</span>), variables_cat),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;ord&#39;</span>, StandardScaler(), variables_ord)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Pipeline(</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&#39;preprocession&#39;</span>, preprocess),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&#39;logreg&#39;</span>, LogisticRegression())</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> model_selection.train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.20</span>, random_state<span class="op">=</span>seed)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>logreg <span class="op">=</span> model.fit(X_train, y_train)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mesure_reg(reg, X_test, y_test):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    y_test_pred <span class="op">=</span> reg.predict(X_test)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_test, y_test_pred)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    total<span class="op">=</span><span class="bu">sum</span>(<span class="bu">sum</span>(cm))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    sensitivity_recall <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">0</span>])</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Sensitivity_recall : &#39;</span>,sensitivity_recall )</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    Specificity <span class="op">=</span> cm[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">/</span>(cm[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">+</span>cm[<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Specificity: &#39;</span>, Specificity)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Precision: &#39;</span>, precision)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">1</span>])<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">0</span>,<span class="dv">1</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">1</span>])</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Accuracy: &#39;</span>, accuracy)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="st">&#39;Matrice de confusion de la régression logistique&#39;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    disp <span class="op">=</span> plot_confusion_matrix(reg,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                                 X_test,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                                 y_test,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                                 cmap<span class="op">=</span>plt.cm.Blues)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    disp.ax_.set_title(title)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mesure_reg(logreg, X_test, y_test)</span></code></pre></div>
<pre><code>Sensitivity_recall :  0.8013245033112583
Specificity:  0.6122448979591837
Precision:  0.8642857142857143
Accuracy:  0.755</code></pre>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-1.png" width="624" /></p>
</div>
<h1 id="evasion">Evasion</h1>
<p>On va chercher les variables non vérifiables et les modifiées jusqu’à ce que l’individu refusé soit accepté.</p>
<p><a href="https://archive.ics.uci.edu/ml/datasets/statlog+(german+credit+data)">Source</a></p>
<p>On voit qu’il n’y a que très peu de variables que l’on peut modifier et qui ne soit pas vérifiable. C’est une base de données pour crédit ce qui explique cela. On voit qu’il y a : - purpose : correspond à la finalité du prêt - personal_status : la condition de vie en couple</p>
<p>On a également des variables difficilements vérifiables : - present_emp_since : depuis quand la personne travail à son poste - job : le type de travaille de la personne - people_under_maintenance : le nombre de personne à charge</p>
<p>On choisit ensuite une personne aléatoirement parmis les personnes refusées :</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#np.random.seed(seed)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>idx_ref <span class="op">=</span> np.where(logreg.predict_proba(X)[:, <span class="dv">1</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>)[<span class="dv">0</span>]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.random.choice(idx_ref)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#idx = 153 # --&gt; juste besoin de changer le but du prêt : &#39;education&#39;, &#39;(vacation - does not exist?)&#39;, &#39;car (new)&#39;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#idx = 232 #--&gt; pas possible de le faire passer</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>X.iloc[idx]</span></code></pre></div>
<pre><code>account_check_status                                          0 &lt;= ... &lt; 200 DM
duration_in_month                                                            24
credit_history                                  delay in paying off in the past
purpose                                                               car (new)
credit_amount                                                              1965
savings                                             unknown/ no savings account
present_emp_since                                            1 &lt;= ... &lt; 4 years
installment_as_income_perc                                                    4
sex                                                                      female
personal _status                                                       divorced
other_debtors                                                              none
present_res_since                                                             4
property                      if not A121/A122 : car or other, not in attrib...
age                                                                          42
other_installment_plans                                                    none
housing                                                                    rent
credits_this_bank                                                             2
job                                                 skilled employee / official
people_under_maintenance                                                      1
telephone                              yes, registered under the customers name
foreign_worker                                                              yes
Name: 591, dtype: object</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>logreg.predict_proba(X.iloc[idx].to_frame().transpose())[:, <span class="dv">1</span>]</span></code></pre></div>
<pre><code>array([0.60792326])</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>var_values <span class="op">=</span> [<span class="st">&#39;purpose&#39;</span>, <span class="st">&#39;personal _status&#39;</span>, <span class="st">&#39;present_emp_since&#39;</span>, <span class="st">&#39;job&#39;</span>, <span class="st">&#39;people_under_maintenance&#39;</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>fix_values <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> X.columns <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> var_values]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>all_values <span class="op">=</span> [X[col].unique() <span class="cf">for</span> col <span class="kw">in</span> var_values]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>prod <span class="op">=</span> <span class="bu">list</span>(product(<span class="op">*</span>all_values))   <span class="co">#produit cartésien</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>all_X <span class="op">=</span> pd.DataFrame([X.iloc[idx][fix_values].tolist() <span class="op">+</span> <span class="bu">list</span>(p) <span class="cf">for</span> p <span class="kw">in</span> prod],</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                      columns<span class="op">=</span>fix_values <span class="op">+</span> var_values)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>all_X <span class="op">=</span> all_X[X.columns]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>all_X[<span class="st">&#39;proba&#39;</span>] <span class="op">=</span> logreg.predict_proba(all_X)[:, <span class="dv">1</span>]</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>all_X.sort_values(<span class="st">&#39;proba&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>valid_X <span class="op">=</span> all_X[all_X.proba <span class="op">&lt;</span> <span class="fl">0.5</span>]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># On calcule le nombre de variable qu&#39;on a du modifier</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>valid_X <span class="op">=</span> valid_X.assign(diff <span class="op">=</span> [(valid_X.iloc[i][var_values] <span class="op">==</span> X.iloc[idx][var_values]).value_counts()[<span class="va">False</span>] </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                                       <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(valid_X))])</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>valid_X.sort_values(by<span class="op">=</span>[<span class="st">&#39;diff&#39;</span>, <span class="st">&#39;proba&#39;</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>valid_X.head(<span class="dv">5</span>)</span></code></pre></div>
<pre><code>     account_check_status  duration_in_month  ...     proba diff
528     0 &lt;= ... &lt; 200 DM                 24  ...  0.210769    1
48      0 &lt;= ... &lt; 200 DM                 24  ...  0.389484    1
1008    0 &lt;= ... &lt; 200 DM                 24  ...  0.416004    1
1128    0 &lt;= ... &lt; 200 DM                 24  ...  0.419004    1
368     0 &lt;= ... &lt; 200 DM                 24  ...  0.440051    1

[5 rows x 23 columns]</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_diff(new_comb, old_comb):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    diff_comb <span class="op">=</span> (new_comb <span class="op">!=</span> old_comb)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    diff_pd <span class="op">=</span> pd.DataFrame([old_comb[diff_comb], new_comb[diff_comb]], index<span class="op">=</span>[<span class="st">&#39;old&#39;</span>, <span class="st">&#39;new&#39;</span>]).transpose()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    max_ind <span class="op">=</span> <span class="bu">max</span>([<span class="bu">len</span>(x) <span class="cf">for</span> x <span class="kw">in</span> diff_pd.index])</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    max_old <span class="op">=</span> <span class="bu">max</span>([<span class="bu">len</span>(x) <span class="cf">for</span> x <span class="kw">in</span> diff_pd.old])</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    max_new <span class="op">=</span> <span class="bu">max</span>([<span class="bu">len</span>(x) <span class="cf">for</span> x <span class="kw">in</span> diff_pd.new])</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> new_comb[diff_comb].index :</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&#39;</span><span class="sc">{i:</span><span class="op">&lt;</span>{max_ind}<span class="sc">}</span><span class="ss"> : </span><span class="sc">{</span>diff_pd<span class="sc">.</span>old[i]<span class="sc">:</span><span class="op">&lt;</span>{max_old}<span class="sc">}</span><span class="ss"> --&gt; </span><span class="sc">{</span>diff_pd<span class="sc">.</span>new[i]<span class="sc">:</span><span class="op">&lt;</span>{max_new}<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>print_diff(valid_X.iloc[<span class="dv">0</span>][var_values], X.iloc[idx][var_values])</span></code></pre></div>
<pre><code>purpose : car (new) --&gt; car (used)</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>X_ref <span class="op">=</span> X.loc[idx_ref]</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>new <span class="op">=</span> <span class="va">False</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> new:</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    all_X <span class="op">=</span> pd.DataFrame([X.iloc[idx][fix_values].tolist() <span class="op">+</span> <span class="bu">list</span>(p)  <span class="op">+</span> [idx] <span class="cf">for</span> idx <span class="kw">in</span> tqdm(idx_ref) <span class="cf">for</span> p <span class="kw">in</span> prod],</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                         columns<span class="op">=</span>fix_values <span class="op">+</span> var_values <span class="op">+</span> [<span class="st">&#39;index_old&#39;</span>])</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    all_X <span class="op">=</span> all_X[<span class="bu">list</span>(X.columns) <span class="op">+</span> [<span class="st">&#39;index_old&#39;</span>]]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    all_X[<span class="st">&#39;proba&#39;</span>] <span class="op">=</span> logreg.predict_proba(all_X.drop(<span class="st">&#39;index_old&#39;</span>, axis<span class="op">=</span><span class="dv">1</span>))[:, <span class="dv">1</span>]</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    np.savez_compressed(<span class="st">&#39;data/privacy/all_X.npz&#39;</span>, data<span class="op">=</span>np.array(all_X), columns<span class="op">=</span>all_X.columns)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span> <span class="op">=</span> np.load(<span class="st">&#39;data/privacy/all_X.npz&#39;</span>, allow_pickle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    all_X <span class="op">=</span> pd.DataFrame(<span class="bu">file</span>[<span class="st">&#39;data&#39;</span>], columns<span class="op">=</span><span class="bu">file</span>[<span class="st">&#39;columns&#39;</span>])</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>X_false <span class="op">=</span> X.loc[idx_ref]</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>X_false <span class="op">=</span> X_false.assign(proba <span class="op">=</span> logreg.predict_proba(X_false)[:, <span class="dv">1</span>])</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>X_false <span class="op">=</span> X_false.assign(proba_min <span class="op">=</span> all_X.groupby(<span class="st">&#39;index_old&#39;</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.sort_values(<span class="st">&#39;proba&#39;</span>).head(<span class="dv">1</span>)) <span class="op">\</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                                                                .set_index(<span class="st">&#39;index_old&#39;</span>).proba)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(X_false[X_false.proba_min <span class="op">&lt;</span> <span class="fl">0.5</span>])</span></code></pre></div>
<pre><code>212</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(X_false.proba <span class="op">-</span> X_false.proba_min).plot.hist()</span></code></pre></div>
<pre><code>&lt;AxesSubplot:ylabel=&#39;Frequency&#39;&gt;</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-3.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>X_false[X_false.proba_min <span class="op">&gt;=</span> <span class="fl">0.5</span>]</span></code></pre></div>
<pre><code>    account_check_status  duration_in_month  ...     proba proba_min
29                &lt; 0 DM                 60  ...  0.864682   0.52768
95     0 &lt;= ... &lt; 200 DM                 54  ...  0.930303  0.664193
334               &lt; 0 DM                 24  ...  0.866776  0.519487
374    0 &lt;= ... &lt; 200 DM                 60  ...  0.950675  0.706918
538               &lt; 0 DM                 48  ...  0.940321  0.641234
650               &lt; 0 DM                 48  ...  0.819160  0.506383
714    0 &lt;= ... &lt; 200 DM                 60  ...  0.930525    0.6976
728    0 &lt;= ... &lt; 200 DM                 48  ...  0.925651  0.524549
832               &lt; 0 DM                 45  ...  0.874828  0.549941
927               &lt; 0 DM                 48  ...  0.772503  0.723198
973               &lt; 0 DM                 60  ...  0.937913  0.725362

[11 rows x 23 columns]</code></pre>
</div>
<h1 id="poisoning">Poisoning</h1>
<p>On remarque qu’il y a certaine personne pour qui la modification de variables difficilement vérifiables n’est pas suffisant. On passe donc à la deuxième attaque <em>poisoning</em>. On a vu précédemment que l’individu <em>232</em> fait partie des personnes ne pouvant pas utiliser la triche pour pouvoir être accepté.</p>
<p>On va rajouter sa ligne dans la base de donnée d’entrainement et voir si cela a un impact.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> credit[<span class="st">&#39;default&#39;</span>]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> credit.drop(columns<span class="op">=</span><span class="st">&quot;default&quot;</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>ind <span class="op">=</span> X.iloc[[<span class="dv">95</span>]]</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>ind</span></code></pre></div>
<pre><code>   account_check_status  ...  foreign_worker
95    0 &lt;= ... &lt; 200 DM  ...             yes

[1 rows x 21 columns]</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>X_train_pois <span class="op">=</span> X_train.append([ind]<span class="op">*</span>n, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>y_train_pois <span class="op">=</span> pd.Series(<span class="bu">list</span>(y_train) <span class="op">+</span> [<span class="dv">0</span>]<span class="op">*</span>n)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>logreg <span class="op">=</span> model.fit(X_train, y_train)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>mesure_reg(logreg, X_test, y_test)</span></code></pre></div>
<pre><code>Sensitivity_recall :  0.8013245033112583
Specificity:  0.6122448979591837
Precision:  0.8642857142857143
Accuracy:  0.755</code></pre>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-5.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>logreg.predict_proba(ind)[<span class="dv">0</span>,<span class="dv">1</span>]</span></code></pre></div>
<pre><code>0.9303033801912368</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>logreg_pois <span class="op">=</span> model.fit(X_train_pois, y_train_pois)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>mesure_reg(logreg_pois, X_test, y_test)</span></code></pre></div>
<pre><code>Sensitivity_recall :  0.7806451612903226
Specificity:  0.5777777777777777
Precision:  0.8642857142857143
Accuracy:  0.735</code></pre>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-7.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>logreg_pois.predict_proba(ind)[<span class="dv">0</span>,<span class="dv">1</span>]</span></code></pre></div>
<pre><code>0.47122487407898306</code></pre>
</div>
<p>On automatise la recherche du nombre minimum de copie pour passer.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> min_pois(ind):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    X_train_pois <span class="op">=</span> X_train</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    y_train_pois <span class="op">=</span> y_train</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> model.fit(X_train_pois, y_train_pois).predict_proba(ind)[<span class="dv">0</span>,<span class="dv">1</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>:</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        n <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>        X_train_pois <span class="op">=</span> X_train_pois.append([ind], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        y_train_pois <span class="op">=</span> pd.Series(<span class="bu">list</span>(y_train_pois) <span class="op">+</span> [<span class="dv">0</span>])</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>min_pois(ind)</span></code></pre></div>
<pre><code>9</code></pre>
</div>
<p>On regarde la distribution pour les personnes qui ont besoin du poisoning</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>list_min <span class="op">=</span> X_false[X_false.proba_min <span class="op">&gt;</span> <span class="fl">0.5</span>].drop(columns<span class="op">=</span>[<span class="st">&#39;proba&#39;</span>, <span class="st">&#39;proba_min&#39;</span>]).<span class="bu">apply</span>(<span class="kw">lambda</span> x: min_pois(x.to_frame().transpose()), axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>list_min.plot.hist()</span></code></pre></div>
<pre><code>&lt;AxesSubplot:ylabel=&#39;Frequency&#39;&gt;</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-9.png" width="624" /></p>
</div>
<p>On peut coupler les deux premières attaques pour avoir encore moins de copie à rajouter.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>ind_best_comb <span class="op">=</span> all_X[all_X[<span class="st">&#39;index_old&#39;</span>] <span class="op">==</span> ind.index[<span class="dv">0</span>]].sort_values(by<span class="op">=</span><span class="st">&#39;proba&#39;</span>).head(<span class="dv">1</span>)  <span class="op">\</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                                            .drop([<span class="st">&#39;index_old&#39;</span>, <span class="st">&#39;proba&#39;</span>], axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>print_diff(ind_best_comb.iloc[<span class="dv">0</span>], ind.iloc[<span class="dv">0</span>])</span></code></pre></div>
<pre><code>purpose           : business                    --&gt; car (used)                                                   
present_emp_since : ... &lt; 1 year                --&gt; 4 &lt;= ... &lt; 7 years                                           
job               : skilled employee / official --&gt; management/ self-employed/ highly qualified employee/ officer</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>X_train_pois_best <span class="op">=</span> X_train.append([ind_best_comb]<span class="op">*</span>n, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>y_train_pois_best <span class="op">=</span> pd.Series(<span class="bu">list</span>(y_train) <span class="op">+</span> [<span class="dv">0</span>]<span class="op">*</span>n)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>logreg_pois_best <span class="op">=</span> model.fit(X_train_pois_best, y_train_pois_best)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>mesure_reg(logreg_pois_best, X_test, y_test)</span></code></pre></div>
<pre><code>Sensitivity_recall :  0.7894736842105263
Specificity:  0.5833333333333334
Precision:  0.8571428571428571
Accuracy:  0.74</code></pre>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-11.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>logreg_pois_best.predict_proba(ind_best_comb)[<span class="dv">0</span>,<span class="dv">1</span>]</span></code></pre></div>
<pre><code>0.4932345933281425</code></pre>
</div>
<p>On automatise</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> min_pois_best_comb(ind, print_chan<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    ind_best_comb <span class="op">=</span> all_X[all_X[<span class="st">&#39;index_old&#39;</span>] <span class="op">==</span> ind.index[<span class="dv">0</span>]].sort_values(by<span class="op">=</span><span class="st">&#39;proba&#39;</span>).head(<span class="dv">1</span>)  <span class="op">\</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                                            .drop([<span class="st">&#39;index_old&#39;</span>, <span class="st">&#39;proba&#39;</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    print_diff(ind_best_comb.iloc[<span class="dv">0</span>], ind.iloc[<span class="dv">0</span>]) <span class="cf">if</span> print_chan <span class="cf">else</span> ...</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    X_train_pois <span class="op">=</span> X_train</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    y_train_pois <span class="op">=</span> y_train</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> model.fit(X_train_pois, y_train_pois).predict_proba(ind_best_comb)[<span class="dv">0</span>,<span class="dv">1</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>:</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>        n <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>        X_train_pois <span class="op">=</span> X_train_pois.append([ind_best_comb], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        y_train_pois <span class="op">=</span> pd.Series(<span class="bu">list</span>(y_train_pois) <span class="op">+</span> [<span class="dv">0</span>])</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>min_pois_best_comb(ind)</span></code></pre></div>
<pre><code>purpose           : business                    --&gt; car (used)                                                   
present_emp_since : ... &lt; 1 year                --&gt; 4 &lt;= ... &lt; 7 years                                           
job               : skilled employee / official --&gt; management/ self-employed/ highly qualified employee/ officer
2</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %%capture</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>list_min_best_comb <span class="op">=</span> X_false[X_false.proba_min <span class="op">&gt;</span> <span class="fl">0.5</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                                                            min_pois_best_comb(x.to_frame().transpose(), <span class="va">False</span>), axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>list_min_best_comb.plot.hist()</span></code></pre></div>
<pre><code>&lt;AxesSubplot:ylabel=&#39;Frequency&#39;&gt;</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-13.png" width="624" /></p>
</div>
<h1 id="model-extraction">Model extraction</h1>
<p>Le but de cette attaque est de réccupérer les poids d’un modèle. On suppose que l’on connait l’architechure : regression logistique.</p>
<p>Ce que l’on va faire c’est créer des nouvelles entrées que l’on va donné à notre modèle blackbox qui va les labélisé puis on va utilser ces labels pour entrainer notre nouveau modèle.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> new_entries(n):</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    list_entries <span class="op">=</span> []</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> X.columns:</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>        list_entries.append(np.random.choice(X[col].unique(), n, p<span class="op">=</span>(X[col].value_counts(normalize<span class="op">=</span><span class="va">True</span>)).to_numpy()))</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(np.array(list_entries).transpose(), columns<span class="op">=</span>X.columns)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(X_train)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>X_new <span class="op">=</span> new_entries(n)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>y_new <span class="op">=</span> logreg.predict(X_new)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>mesure_reg(model.fit(X_train, y_train), X_test, y_test)</span></code></pre></div>
<pre><code>Sensitivity_recall :  0.8013245033112583
Specificity:  0.6122448979591837
Precision:  0.8642857142857143
Accuracy:  0.755</code></pre>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-15.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb65"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>mesure_reg(model.fit(X_new, y_new), X_test, y_test)</span></code></pre></div>
<pre><code>Sensitivity_recall :  0.7922077922077922
Specificity:  0.6086956521739131
Precision:  0.8714285714285714
Accuracy:  0.75</code></pre>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-17.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb67"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> new_entries_unif(n):</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    list_entries <span class="op">=</span> []</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> X.columns:</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>        list_entries.append(np.random.choice(X[col].unique(), n))</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(np.array(list_entries).transpose(), columns<span class="op">=</span>X.columns)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb68"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(X_train)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>X_new_unif <span class="op">=</span> new_entries_unif(n)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>logreg <span class="op">=</span> model.fit(X_train, y_train)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>y_new_unif <span class="op">=</span> logreg.predict(X_new_unif)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb69"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>mesure_reg(model.fit(X_new_unif, y_new_unif), X_test, y_test)</span></code></pre></div>
<pre><code>Sensitivity_recall :  0.8053691275167785
Specificity:  0.6078431372549019
Precision:  0.8571428571428571
Accuracy:  0.755</code></pre>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-19.png" width="624" /></p>
</div>
<p>Mesure de distance : - l’accuracy : mesure de l’efficacité de l’apprentissage - la précision : mesure de la distance du modèle original</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb71"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>y_hat <span class="op">=</span> model.fit(X_new, y_new).predict(X_test)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>y_ori <span class="op">=</span> model.fit(X_train, y_train).predict(X_test)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>prec <span class="op">=</span> (y_ori <span class="op">==</span> y_hat).astype(<span class="bu">int</span>).<span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(y_ori)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>accu_diff <span class="op">=</span> accuracy_score(y_test, y_ori) <span class="op">-</span> accuracy_score(y_test, y_hat)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Précision : </span><span class="sc">{</span>prec<span class="sc">:.3f}</span><span class="ss">, Différence d&#39;accuracy : </span><span class="sc">{</span>accu_diff<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<pre><code>Précision : 0.905, Différence d&#39;accuracy : 0.005</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb73"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>y_hat <span class="op">=</span> model.fit(X_new_unif, y_new_unif).predict(X_test)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>y_ori <span class="op">=</span> model.fit(X_train, y_train).predict(X_test)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>prec <span class="op">=</span> (y_ori <span class="op">==</span> y_hat).astype(<span class="bu">int</span>).<span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(y_ori)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>accu_diff <span class="op">=</span> accuracy_score(y_test, y_ori) <span class="op">-</span> accuracy_score(y_test, y_hat)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Précision : </span><span class="sc">{</span>prec<span class="sc">:.3f}</span><span class="ss">, Différence d&#39;accuracy : </span><span class="sc">{</span>accu_diff<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<pre><code>Précision : 0.960, Différence d&#39;accuracy : 0.000</code></pre>
</div>
<h1 id="trouver-un-modèle-capable-de-surapprendre">Trouver un modèle capable de surapprendre</h1>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb75"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_relations(df_orig):</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df_orig.copy()</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, j <span class="kw">in</span> combinations(variables_cat, <span class="dv">2</span>):</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>        df[i <span class="op">+</span> j] <span class="op">=</span> df[i] <span class="op">+</span> df[j]</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>new_variables_cat <span class="op">=</span> variables_cat <span class="op">+</span> [i <span class="op">+</span> j <span class="cf">for</span> i, j <span class="kw">in</span> combinations(variables_cat, <span class="dv">2</span>)]</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co"># On normalise les colones dans leur noms</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>all_values <span class="op">=</span> [X[col].unique() <span class="cf">for</span> col <span class="kw">in</span> variables_cat]</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>categorie_rel <span class="op">=</span> <span class="bu">list</span>(combinations(all_values, <span class="dv">2</span>))</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>categorie_name <span class="op">=</span> [a <span class="op">+</span> b <span class="cf">for</span> a,b <span class="kw">in</span> combinations(variables_cat, <span class="dv">2</span>)]</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>categorie_values <span class="op">=</span> [[a <span class="op">+</span> b <span class="cf">for</span> a,b <span class="kw">in</span> <span class="bu">list</span>(product(<span class="op">*</span>x))] <span class="cf">for</span> x <span class="kw">in</span> categorie_rel]</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>preprocessor_comb <span class="op">=</span> ColumnTransformer(</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;cat&#39;</span>, OneHotEncoder(categories<span class="op">=</span>all_values<span class="op">+</span>categorie_values, drop<span class="op">=</span><span class="st">&#39;first&#39;</span>, sparse<span class="op">=</span><span class="va">False</span>), </span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>         new_variables_cat),</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;ord&#39;</span>, StandardScaler(), variables_ord)</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>model_over <span class="op">=</span> Pipeline(</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;relations&#39;</span>, FunctionTransformer(add_relations)), </span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;preprocession&#39;</span>, preprocessor_comb),</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;logreg&#39;</span>, LogisticRegression(max_iter<span class="op">=</span><span class="dv">200</span>))</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb76"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># #%timeit model.fit(X_train, y_train)</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co">#print(f&quot;validation : {model.score(X_test, y_test):.3f}, score : {model.score(X_train, y_train):.3f}&quot;) </span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;&quot;&quot;39.1 ms ± 2.89 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="st">validation : 0.735, score : 0.787&quot;&quot;&quot;</span>)</span></code></pre></div>
<pre><code>39.1 ms ± 2.89 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
validation : 0.735, score : 0.787</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb78"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># #%timeit model_over.fit(X_train, y_train)</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co">#print(f&quot;validation : {model_over.score(X_test, y_test):.3f}, score : {model_over.score(X_train, y_train):.3f}&quot;) </span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;&quot;&quot;216 ms ± 21.8 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="st">validation : 0.725, score : 0.958&quot;&quot;&quot;</span>)</span></code></pre></div>
<pre><code>216 ms ± 21.8 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
validation : 0.725, score : 0.958</code></pre>
</div>
<p>On a donc de l’overfit</p>
<h1 id="proprety-inference">Proprety inference</h1>
<p>On va chercher a reccupérer la proportion homme/femme de la base de donnée d’entrainement</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb80"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>dist <span class="op">=</span> np.random.normal(np.random.choice([<span class="fl">0.4</span>, <span class="fl">0.6</span>], size<span class="op">=</span><span class="dv">1000</span>), scale<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>plt.hist(dist, density<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span></code></pre></div>
<pre><code>(array([0.10510399, 0.10510399, 0.42041596, 0.84083192, 0.42041596,
       0.42041596, 0.52551995, 0.9459359 , 1.15614388, 2.83780771,
       1.89187181, 2.52249575, 3.25822367, 3.15311968, 4.51947154,
       3.04801569, 4.83478351, 3.36332766, 4.09905559, 2.83780771,
       1.89187181, 3.15311968, 1.26124787, 1.9969758 , 1.47145585,
       1.05103989, 0.84083192, 1.05103989, 1.26124787, 1.78676782,
       2.73270372, 2.83780771, 3.04801569, 3.04801569, 3.36332766,
       3.88884761, 4.41436756, 4.30926357, 3.15311968, 2.9429117 ,
       2.9429117 , 2.73270372, 1.9969758 , 1.89187181, 1.36635186,
       1.36635186, 0.52551995, 0.63062394, 0.52551995, 0.31531197]), array([0.25426357, 0.26377796, 0.27329234, 0.28280673, 0.29232112,
       0.3018355 , 0.31134989, 0.32086428, 0.33037866, 0.33989305,
       0.34940744, 0.35892182, 0.36843621, 0.3779506 , 0.38746498,
       0.39697937, 0.40649376, 0.41600814, 0.42552253, 0.43503692,
       0.4445513 , 0.45406569, 0.46358008, 0.47309446, 0.48260885,
       0.49212324, 0.50163762, 0.51115201, 0.5206664 , 0.53018079,
       0.53969517, 0.54920956, 0.55872395, 0.56823833, 0.57775272,
       0.58726711, 0.59678149, 0.60629588, 0.61581027, 0.62532465,
       0.63483904, 0.64435343, 0.65386781, 0.6633822 , 0.67289659,
       0.68241097, 0.69192536, 0.70143975, 0.71095413, 0.72046852,
       0.72998291]), &lt;BarContainer object of 50 artists&gt;)</code></pre>
<div class="sourceCode" id="cb82"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-21.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb83"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> new_entries_homme(n, prop<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    list_entries <span class="op">=</span> []</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> X.columns:</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="op">==</span> <span class="st">&#39;sex&#39;</span>:</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>            q <span class="op">=</span> np.clip(np.random.normal(np.random.choice([<span class="fl">0.4</span>, <span class="fl">0.6</span>]), scale<span class="op">=</span><span class="fl">0.05</span>), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>            list_entries.append(np.random.choice([<span class="st">&#39;male&#39;</span>, <span class="st">&#39;female&#39;</span>], n, p<span class="op">=</span>[q, <span class="dv">1</span><span class="op">-</span>q]))</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prop:</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>                list_entries.append(np.random.choice(X[col].unique(), n, p<span class="op">=</span>(X[col].value_counts(normalize<span class="op">=</span><span class="va">True</span>)).to_numpy()))</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>                list_entries.append(np.random.choice(X[col].unique(), n))</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(np.array(list_entries).transpose(), columns<span class="op">=</span>X.columns)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb84"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>new_entries_homme(<span class="dv">1000</span>).sex.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<pre><code>female    0.546
male      0.454
Name: sex, dtype: float64</code></pre>
</div>
<p>On se place dans le cas suivant :</p>
<p>On a un modèle <em>model_secret</em> qui à la structure de <em>model_chose</em> et qui est entrainé sur une base de données : <em>X_train_secret</em>, et une labélisation : <em>y_train_secret</em>. On cherche à savoir si la base de données secrète avait une majorité d’homme.</p>
<p>Pour se faire on va procéder de la manière suivante :</p>
<p>Comme on n’a pas accès à la base de données <em>X_train_secret</em> on va devoir créer une liste de bases : <em>list_data_X</em> qui est une liste de base générée avec la fonction : <em>new_entries_homme</em> qui génére de nouvelles entrées uniformément pour toutes les variables sauf <em>sex</em> où la proportion d’hommes est tirée selon une normale centré en 0,6 ou 0,4 et de écart type 0,05. On utilise le modèle <em>model_secret</em> pour labéliser les nouvelles entrées que l’on garde dans la variable <em>liste_data_y</em>. (étape de <em>model extraction</em>)</p>
<p>Pour chaque nouvelle base de données on entraine un modèle de la structure <em>model_choisi</em> et on récupère les poids de ce modèle. Tous ces poids forme la base <em>data_meta_X</em>. C’est une base de données où chaque entrée <span class="math inline">\(i\)</span> coorespond aux coefficients du modèle entrainé sur <em>(list_data_X[i], list_data_y[i])</em>.</p>
<p>On crée la labélisation de notre méta-modèle <em>data_meta_y</em> en notant <span class="math inline">\(1\)</span> s’il y a plus d’homme que de femme dans le base de données <em>list_data_X[i]</em> et 0 sinon.</p>
<p>On va entrainer notre méta-modèle qui est une régression logstique sur <em>(data_meta_X, data_meta_y)</em></p>
<p>On va finalement donner les coefficients de notre modèle secret à notre méta-modèle et il va nous dire si le modèle secret a été entrainé sur une base de données avec une majoritée d’homme (1) ou de femme (0).</p>
<p><em>FAIRE UN SCHÉMA</em></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb86"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>n_data <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>n_entries <span class="op">=</span> <span class="bu">len</span>(X_train)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>X_train_secret <span class="op">=</span> X_train</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>y_train_secret <span class="op">=</span> y_train</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>prop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>new <span class="op">=</span> <span class="va">False</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Choisir si on veut utiliser le modèle qui surapprend ou pas </span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>model_choisi <span class="op">=</span> model  <span class="co">#model</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">&#39;_overfit&#39;</span> <span class="cf">if</span> model_choisi <span class="op">==</span> model_over <span class="cf">else</span> <span class="st">&#39;&#39;</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>prop_name <span class="op">=</span> <span class="st">&#39;_prop&#39;</span> <span class="cf">if</span> prop <span class="cf">else</span> <span class="st">&#39;_unif&#39;</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>model_secret <span class="op">=</span> deepcopy(model_choisi.fit(X_train_secret, y_train_secret))</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> new:</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>    list_data_X <span class="op">=</span> [new_entries_homme(n_entries, prop) <span class="cf">for</span> _ <span class="kw">in</span> tqdm(<span class="bu">range</span>(n_data))]</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    dist_homme <span class="op">=</span> np.array([(x.sex.value_counts(normalize<span class="op">=</span><span class="va">True</span>))[<span class="st">&#39;male&#39;</span>] <span class="cf">for</span> x <span class="kw">in</span> list_data_X])</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>    list_data_y <span class="op">=</span> model_secret.predict(pd.DataFrame(np.array(list_data_X).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">21</span>), </span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>                                               columns<span class="op">=</span>X.columns)).reshape(n_data, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>    data_meta_X <span class="op">=</span> [model_choisi.fit(list_data_X[i], list_data_y[i])[<span class="st">&#39;logreg&#39;</span>].coef_[<span class="dv">0</span>] </span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>                       <span class="cf">for</span> i <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="bu">len</span>(list_data_X)))]</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    np.savez_compressed(<span class="ss">f&#39;data/privacy/data</span><span class="sc">{</span>name<span class="sc">}{</span>prop_name<span class="sc">}</span><span class="ss">.npz&#39;</span>, </span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>                        data_meta<span class="op">=</span>data_meta_X, </span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>                        list_homme<span class="op">=</span>dist_homme)</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span> <span class="op">=</span> np.load(<span class="ss">f&#39;data/privacy/data</span><span class="sc">{</span>name<span class="sc">}{</span>prop_name<span class="sc">}</span><span class="ss">.npz&#39;</span>, allow_pickle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>    data_meta_X <span class="op">=</span> <span class="bu">file</span>[<span class="st">&#39;data_meta&#39;</span>]</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>    dist_homme <span class="op">=</span> <span class="bu">file</span>[<span class="st">&#39;dist_homme&#39;</span>]</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>data_meta_y <span class="op">=</span> (dist_homme <span class="op">&gt;</span> <span class="fl">0.5</span>).astype(<span class="st">&#39;int&#39;</span>)</span></code></pre></div>
</div>
<h3 id="visualisation-de-la-répartition-de-la-proportion-dhommes-dans-les-bases-de-données">Visualisation de la répartition de la proportion d’hommes dans les bases de données</h3>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb87"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>plt.hist(dist_homme, density<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span></code></pre></div>
<pre><code>(array([0.74487896, 0.37243948, 0.        , 0.74487896, 0.37243948,
       3.35195531, 2.23463687, 2.23463687, 3.35195531, 2.97951583,
       2.23463687, 4.46927374, 3.35195531, 2.23463687, 4.46927374,
       2.60707635, 2.97951583, 2.23463687, 7.44878957, 0.74487896,
       1.48975791, 1.11731844, 1.86219739, 1.48975791, 0.        ,
       1.86219739, 1.86219739, 2.23463687, 1.48975791, 0.74487896,
       1.11731844, 2.97951583, 2.23463687, 2.23463687, 3.72439479,
       2.60707635, 2.60707635, 5.95903166, 5.95903166, 2.97951583,
       5.95903166, 1.48975791, 0.74487896, 1.86219739, 1.48975791,
       1.11731844, 1.11731844, 0.74487896, 0.        , 1.48975791]), array([0.2725 , 0.28145, 0.2904 , 0.29935, 0.3083 , 0.31725, 0.3262 ,
       0.33515, 0.3441 , 0.35305, 0.362  , 0.37095, 0.3799 , 0.38885,
       0.3978 , 0.40675, 0.4157 , 0.42465, 0.4336 , 0.44255, 0.4515 ,
       0.46045, 0.4694 , 0.47835, 0.4873 , 0.49625, 0.5052 , 0.51415,
       0.5231 , 0.53205, 0.541  , 0.54995, 0.5589 , 0.56785, 0.5768 ,
       0.58575, 0.5947 , 0.60365, 0.6126 , 0.62155, 0.6305 , 0.63945,
       0.6484 , 0.65735, 0.6663 , 0.67525, 0.6842 , 0.69315, 0.7021 ,
       0.71105, 0.72   ]), &lt;BarContainer object of 50 artists&gt;)</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-23.png" width="624" /></p>
</div>
<h3 id="entrainement-du-méta-modèle">Entrainement du méta-modèle</h3>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb90"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>X_train_meta, X_test_meta, y_train_meta, y_test_meta <span class="op">=</span> model_selection.train_test_split(data_meta_X, </span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>                                                                                        data_meta_y, </span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>                                                                                        test_size<span class="op">=</span><span class="fl">0.20</span>)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>meta_model <span class="op">=</span> LogisticRegression(max_iter<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>meta_model.fit(X_train_meta, y_train_meta)</span></code></pre></div>
<pre><code>LogisticRegression(max_iter=200)</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb92"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>confusion_matrix(y_test_meta, meta_model.predict(X_test_meta))</span></code></pre></div>
<pre><code>array([[16, 15],
       [14, 15]])</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb94"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>l <span class="op">=</span> []</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>X_train_meta_all, X_test_meta_all, y_train_meta_all, y_test_meta_all <span class="op">=</span> model_selection.train_test_split(data_meta_X, </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>                                                                                        data_meta_y, </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>                                                                                        test_size<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">100</span>)):</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    X_train_meta, _, y_train_meta, _ <span class="op">=</span> model_selection.train_test_split(X_train_meta_all, </span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>                                                                        y_train_meta_all, </span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>                                                                        test_size<span class="op">=</span><span class="fl">0.20</span>)</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    meta_model <span class="op">=</span> LogisticRegression(max_iter<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>    meta_model.fit(X_train_meta, y_train_meta)</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#l += [meta_model.predict_proba(model_secret[&#39;logreg&#39;].coef_)[0,1]]</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    l <span class="op">+=</span> [meta_model.predict_proba([X_test_meta[<span class="dv">0</span>]])[<span class="dv">0</span>,<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>  0%|          | 0/100 [00:00&lt;?, ?it/s]
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)
LogisticRegression(max_iter=200)</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>plt.hist(l, density<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span><span class="st">&#39;b&#39;</span>)</span></code></pre></div>
<pre><code>(array([ 1.32828659,  0.        ,  0.        ,  0.        ,  0.        ,
        0.        ,  0.        ,  1.32828659,  0.        ,  0.        ,
        0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
        0.        ,  2.65657318,  0.        ,  3.98485976,  0.        ,
        1.32828659,  5.31314635,  1.32828659,  0.        ,  1.32828659,
        2.65657318,  3.98485976,  3.98485976,  2.65657318,  2.65657318,
        2.65657318,  5.31314635,  6.64143294,  2.65657318,  5.31314635,
        2.65657318,  3.98485976,  6.64143294, 10.6262927 ,  7.96971953,
        3.98485976,  3.98485976, 10.6262927 ,  6.64143294,  1.32828659,
        1.32828659,  7.96971953,  2.65657318,  2.65657318,  2.65657318]), array([0.35235944, 0.35988794, 0.36741643, 0.37494493, 0.38247342,
       0.39000192, 0.39753041, 0.40505891, 0.41258741, 0.4201159 ,
       0.4276444 , 0.43517289, 0.44270139, 0.45022989, 0.45775838,
       0.46528688, 0.47281537, 0.48034387, 0.48787236, 0.49540086,
       0.50292936, 0.51045785, 0.51798635, 0.52551484, 0.53304334,
       0.54057183, 0.54810033, 0.55562883, 0.56315732, 0.57068582,
       0.57821431, 0.58574281, 0.59327131, 0.6007998 , 0.6083283 ,
       0.61585679, 0.62338529, 0.63091378, 0.63844228, 0.64597078,
       0.65349927, 0.66102777, 0.66855626, 0.67608476, 0.68361326,
       0.69114175, 0.69867025, 0.70619874, 0.71372724, 0.72125573,
       0.72878423]), &lt;BarContainer object of 50 artists&gt;)</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-25.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb99"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test_meta[<span class="dv">0</span>])</span></code></pre></div>
<pre><code>1</code></pre>
</div>
<h3 id="régression-linéaire-pour-trouver-le-proportion-dhomme">Régression linéaire pour trouver le proportion d’homme</h3>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb101"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>data_meta_y_linear <span class="op">=</span> dist_homme</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>X_train_meta, X_test_meta, y_train_meta, y_test_meta <span class="op">=</span> model_selection.train_test_split(data_meta_X, </span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>                                                                                        data_meta_y_linear, </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>                                                                                        test_size<span class="op">=</span><span class="fl">0.20</span>, </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>                                                                                        random_state<span class="op">=</span>seed)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb102"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>meta_model_linear <span class="op">=</span> LinearRegression()</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>meta_model_linear.fit(X_train_meta, y_train_meta)</span></code></pre></div>
<pre><code>LinearRegression()</code></pre>
</div>
<p>On regarde la différence moyenne en pourcentage entre la prévision du modèle et la réalité</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb104"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>((np.<span class="bu">abs</span>(y_test_meta <span class="op">-</span> meta_model_linear.predict(X_test_meta))<span class="op">/</span>y_test_meta) <span class="op">*</span> <span class="dv">100</span>).mean()</span></code></pre></div>
<pre><code>24.322101347546102</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb106"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>meta_model_linear.predict(model_secret[<span class="st">&#39;logreg&#39;</span>].coef_)</span></code></pre></div>
<pre><code>array([-0.00056166])</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb108"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> svm</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>meta_model_svr <span class="op">=</span> svm.LinearSVR(max_iter<span class="op">=</span><span class="dv">100000</span>)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>meta_model_svr.fit(X_train_meta, y_train_meta)</span></code></pre></div>
<pre><code>LinearSVR(max_iter=100000)</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb110"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>((np.<span class="bu">abs</span>(y_test_meta <span class="op">-</span> meta_model_svr.predict(X_test_meta))<span class="op">/</span>y_test_meta) <span class="op">*</span> <span class="dv">100</span>).mean()</span></code></pre></div>
<pre><code>26.66214480664375</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb112"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>meta_model_svr.predict(model_secret[<span class="st">&#39;logreg&#39;</span>].coef_)</span></code></pre></div>
<pre><code>array([0.15982339])</code></pre>
</div>
<h1 id="differential-privacy">Differential Privacy</h1>
<p>On utilise la librairie <em>diffprivlib</em> qui permet d’implémenter avec des modèles de <em>sklearn</em> la <em>differential privacy</em>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb114"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> diffprivlib.models <span class="im">as</span> diff</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb115"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>epsilon<span class="op">=</span><span class="dv">1</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>data_norm<span class="op">=</span><span class="dv">1</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>model_over_diff <span class="op">=</span> Pipeline(</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;relations&#39;</span>, FunctionTransformer(add_relations)), </span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;preprocession&#39;</span>, preprocessor_comb),</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># La seule différence avec model_over</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&#39;logreg&#39;</span>, diff.LogisticRegression(max_iter<span class="op">=</span><span class="dv">200</span>, epsilon<span class="op">=</span>epsilon, data_norm<span class="op">=</span>data_norm))</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb116"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>model_over_diff.fit(X_train, y_train)</span></code></pre></div>
<pre><code>Pipeline(steps=[(&#39;relations&#39;,
                 FunctionTransformer(func=&lt;function add_relations at 0x7fed242241f0&gt;)),
                (&#39;preprocession&#39;,
                 ColumnTransformer(transformers=[(&#39;cat&#39;,
                                                  OneHotEncoder(categories=[array([&#39;&lt; 0 DM&#39;, &#39;0 &lt;= ... &lt; 200 DM&#39;, &#39;no checking account&#39;,
       &#39;&gt;= 200 DM / salary assignments for at least 1 year&#39;], dtype=object),
                                                                            array([&#39;critical account/ other credits existing (not at this bank)&#39;,
       &#39;exi...
                                                   &#39;credit_historypurpose&#39;,
                                                   &#39;credit_historysavings&#39;,
                                                   &#39;credit_historypresent_emp_since&#39;, ...]),
                                                 (&#39;ord&#39;, StandardScaler(),
                                                  [&#39;duration_in_month&#39;,
                                                   &#39;credit_amount&#39;,
                                                   &#39;installment_as_income_perc&#39;,
                                                   &#39;present_res_since&#39;, &#39;age&#39;,
                                                   &#39;credits_this_bank&#39;,
                                                   &#39;people_under_maintenance&#39;])])),
                (&#39;logreg&#39;,
                 LogisticRegression(accountant=BudgetAccountant(spent_budget=[(1, 0)]),
                                    data_norm=1, epsilon=1, max_iter=200))])</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;validation : </span><span class="sc">{</span>model_over_diff<span class="sc">.</span>score(X_test, y_test)<span class="sc">:.3f}</span><span class="ss">, score : </span><span class="sc">{</span>model_over_diff<span class="sc">.</span>score(X_train, y_train)<span class="sc">:.3f}</span><span class="ss">&quot;</span>) </span></code></pre></div>
<pre><code>validation : 0.340, score : 0.345</code></pre>
</div>
<p>C’est là où il y a un problème on ne peut plus vraiment utilisé le modèle secret pour auto-labélisé les nouvelles données car il perd en efficacité donc la labélisation de <em>y_train_secret</em> est vraiment différentes de l’auto-labélisation. Il faut donc s’éloigner de la situation initale qui combinait le <em>proprety inference</em> et le <em>model extraction</em> comme on ne veut que le premier on va suivre le protocole suivant :</p>
<ul>
<li><p>On va créer un <em>pool</em> de données (100000)</p></li>
<li><p>On utilise le <em>model_secret</em> entrainé sur (X_train_secret, y_train_secret) pour auto-labélisé</p></li>
<li><p>On va tirer une base de données secrete parmis ces données que l’on va renommé <em>data_secret</em></p></li>
<li><p>La liste de data va être tirée dans la <em>pool</em> en tirant le bon nombre d’entrées hommme et femme</p></li>
<li><p>On entraine de la même manière le meta modèle mais cette fois-ci : y_train_secret et le y de list_data_y sont de même forme</p></li>
</ul>
<h4 id="creation-dun-très-grand-nombre-dentrées">Creation d’un très grand nombre d’entrées</h4>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb120"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> new_entries_unif_sex(n):</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    list_entries <span class="op">=</span> []</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> X.columns:</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="op">==</span> <span class="st">&#39;sex&#39;</span>:</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>            list_entries.append(np.random.choice(X[col].unique(), n))</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>            list_entries.append(np.random.choice(X[col].unique(), n, p<span class="op">=</span>(X[col].value_counts(normalize<span class="op">=</span><span class="va">True</span>)).to_numpy()))</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(np.array(list_entries).transpose(), columns<span class="op">=</span>X.columns)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb121"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> index_fix_p_homme(p, N):</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    nb_homme <span class="op">=</span> <span class="bu">round</span>(p <span class="op">*</span> N) </span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    male_index <span class="op">=</span> np.random.choice(all_male_index, replace<span class="op">=</span><span class="va">False</span>, size<span class="op">=</span>nb_homme)</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    female_index <span class="op">=</span> np.random.choice(all_female_index, replace<span class="op">=</span><span class="va">False</span>, size<span class="op">=</span>N<span class="op">-</span>nb_homme)</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.concatenate([male_index, female_index])</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb122"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">800</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>new <span class="op">=</span> <span class="va">False</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>model_predict <span class="op">=</span> model_over.fit(X_train, y_train)</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> new:  </span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    data_pool <span class="op">=</span> new_entries_unif_sex(<span class="dv">100000</span>)</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    data_pool[<span class="st">&#39;defaut&#39;</span>] <span class="op">=</span> model_predict.predict(data_pool)</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    all_male_index <span class="op">=</span> data_pool[data_pool.sex <span class="op">==</span> <span class="st">&#39;male&#39;</span>].index</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>    all_female_index <span class="op">=</span> data_pool[data_pool.sex <span class="op">==</span> <span class="st">&#39;female&#39;</span>].index</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>    all_p <span class="op">=</span> np.clip(np.random.normal(np.random.choice([<span class="fl">0.4</span>, <span class="fl">0.6</span>], size<span class="op">=</span>m), scale<span class="op">=</span><span class="fl">0.05</span>), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>    sub_index <span class="op">=</span> [index_fix_p_homme(p, N) <span class="cf">for</span> p <span class="kw">in</span> tqdm(all_p)]</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>    np.savez_compressed(<span class="st">&#39;data/privacy/diff_data.npz&#39;</span>, data_pool<span class="op">=</span>np.array(data_pool), </span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>                        columns_pool<span class="op">=</span>data_pool.columns, sub_index<span class="op">=</span>np.array(sub_index))</span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span> <span class="op">=</span> np.load(<span class="st">&#39;data/privacy/diff_data.npz&#39;</span>, allow_pickle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>    data_pool <span class="op">=</span> pd.DataFrame(<span class="bu">file</span>[<span class="st">&#39;data_pool&#39;</span>], columns<span class="op">=</span><span class="bu">file</span>[<span class="st">&#39;columns_pool&#39;</span>])</span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>    sub_index <span class="op">=</span> <span class="bu">file</span>[<span class="st">&#39;sub_index&#39;</span>]</span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a>sub_data <span class="op">=</span> [data_pool.iloc[indexes] <span class="cf">for</span> indexes <span class="kw">in</span> sub_index]</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb123"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>dist_homme <span class="op">=</span> [(x.sex.value_counts(normalize<span class="op">=</span><span class="va">True</span>))[<span class="st">&#39;male&#39;</span>] <span class="cf">for</span> x <span class="kw">in</span> sub_data]</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>plt.hist(dist_homme, density<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">50</span>)</span></code></pre></div>
<pre><code>(array([0.38314176, 0.38314176, 0.38314176, 0.76628352, 1.14942529,
       2.29885057, 1.14942529, 3.44827586, 1.91570881, 1.91570881,
       4.59770115, 2.29885057, 4.98084291, 5.36398467, 6.89655172,
       1.53256705, 2.68199234, 3.83141762, 0.76628352, 2.29885057,
       1.91570881, 2.68199234, 1.14942529, 3.0651341 , 1.14942529,
       0.76628352, 0.        , 1.53256705, 1.14942529, 1.53256705,
       0.76628352, 2.68199234, 3.44827586, 1.14942529, 3.0651341 ,
       4.59770115, 5.74712644, 4.98084291, 3.83141762, 4.59770115,
       3.83141762, 3.44827586, 2.68199234, 1.14942529, 1.91570881,
       1.53256705, 0.38314176, 0.38314176, 0.        , 0.76628352]), array([0.27625, 0.28495, 0.29365, 0.30235, 0.31105, 0.31975, 0.32845,
       0.33715, 0.34585, 0.35455, 0.36325, 0.37195, 0.38065, 0.38935,
       0.39805, 0.40675, 0.41545, 0.42415, 0.43285, 0.44155, 0.45025,
       0.45895, 0.46765, 0.47635, 0.48505, 0.49375, 0.50245, 0.51115,
       0.51985, 0.52855, 0.53725, 0.54595, 0.55465, 0.56335, 0.57205,
       0.58075, 0.58945, 0.59815, 0.60685, 0.61555, 0.62425, 0.63295,
       0.64165, 0.65035, 0.65905, 0.66775, 0.67645, 0.68515, 0.69385,
       0.70255, 0.71125]), &lt;BarContainer object of 50 artists&gt;)</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="fairness_files/figure-html5/unnamed-chunk-2-27.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb126"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>new <span class="op">=</span> <span class="va">False</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>list_data_X <span class="op">=</span> [df.drop(<span class="st">&#39;defaut&#39;</span>, axis<span class="op">=</span><span class="dv">1</span>) <span class="cf">for</span> df <span class="kw">in</span> sub_data]</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> new:</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    list_data_y <span class="op">=</span> [df.defaut <span class="cf">for</span> df <span class="kw">in</span> sub_data]</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    data_meta_X <span class="op">=</span> [model_over.fit(list_data_X[i], list_data_y[i])[<span class="st">&#39;logreg&#39;</span>].coef_[<span class="dv">0</span>] </span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> i <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="bu">len</span>(list_data_X)))]</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>    np.savez_compressed(<span class="st">&#39;data/privacy/data_meta_over_prop_diff.npz&#39;</span>, data_meta<span class="op">=</span>np.array(data_meta_X))</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>    data_meta_X <span class="op">=</span> np.load(<span class="st">&#39;data/privacy/data_meta_over_prop_diff.npz&#39;</span>)[<span class="st">&#39;data_meta&#39;</span>]</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>data_meta_y <span class="op">=</span> np.array([df.sex.value_counts().index[<span class="dv">0</span>] <span class="op">==</span> <span class="st">&#39;male&#39;</span> </span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">for</span> df <span class="kw">in</span> list_data_X]).astype(<span class="st">&#39;int&#39;</span>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb127"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>X_open, X_secret, y_open, y_secret <span class="op">=</span> model_selection.train_test_split(data_meta_X, </span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>                                                                        data_meta_y, </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>                                                                        test_size<span class="op">=</span><span class="fl">0.20</span>)</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>meta_model <span class="op">=</span> LogisticRegression(max_iter<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>meta_model.fit(X_open, y_open)</span></code></pre></div>
<pre><code>LogisticRegression(max_iter=200)</code></pre>
<div class="sourceCode" id="cb129"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>confusion_matrix(y_secret, meta_model.predict(X_secret))</span></code></pre></div>
<pre><code>array([[16, 16],
       [15, 13]])</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb131"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>all_male_index <span class="op">=</span> data_pool[data_pool.sex <span class="op">==</span> <span class="st">&#39;male&#39;</span>].index</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>all_female_index <span class="op">=</span> data_pool[data_pool.sex <span class="op">==</span> <span class="st">&#39;female&#39;</span>].index</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>X_secret <span class="op">=</span> data_pool.iloc[index_fix_p_homme(<span class="fl">0.6</span>, <span class="dv">1000</span>)].drop(columns<span class="op">=</span>[<span class="st">&#39;defaut&#39;</span>])</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>y_secret <span class="op">=</span> model_predict.predict(X_secret)</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>X_secret_train, X_secret_test, y_secret_train, y_secret_test <span class="op">=</span> model_selection.train_test_split(X_secret, </span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>                                                                                                    y_secret, </span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>                                                                                                    test_size<span class="op">=</span><span class="fl">0.20</span>)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb132"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>model_over.fit(X_secret_train, y_secret_train)</span></code></pre></div>
<pre><code>Pipeline(steps=[(&#39;relations&#39;,
                 FunctionTransformer(func=&lt;function add_relations at 0x7fed242241f0&gt;)),
                (&#39;preprocession&#39;,
                 ColumnTransformer(transformers=[(&#39;cat&#39;,
                                                  OneHotEncoder(categories=[array([&#39;&lt; 0 DM&#39;, &#39;0 &lt;= ... &lt; 200 DM&#39;, &#39;no checking account&#39;,
       &#39;&gt;= 200 DM / salary assignments for at least 1 year&#39;], dtype=object),
                                                                            array([&#39;critical account/ other credits existing (not at this bank)&#39;,
       &#39;exi...
                                                   &#39;account_check_statustelephone&#39;,
                                                   &#39;account_check_statusforeign_worker&#39;,
                                                   &#39;credit_historypurpose&#39;,
                                                   &#39;credit_historysavings&#39;,
                                                   &#39;credit_historypresent_emp_since&#39;, ...]),
                                                 (&#39;ord&#39;, StandardScaler(),
                                                  [&#39;duration_in_month&#39;,
                                                   &#39;credit_amount&#39;,
                                                   &#39;installment_as_income_perc&#39;,
                                                   &#39;present_res_since&#39;, &#39;age&#39;,
                                                   &#39;credits_this_bank&#39;,
                                                   &#39;people_under_maintenance&#39;])])),
                (&#39;logreg&#39;, LogisticRegression(max_iter=200))])</code></pre>
<div class="sourceCode" id="cb134"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>y_test_pred <span class="op">=</span> model_over.predict(X_secret_test)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>cm <span class="op">=</span> confusion_matrix(y_secret_test, y_test_pred)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cm)</span></code></pre></div>
<pre><code>[[138   4]
 [ 23  35]]</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb136"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>X_secret_train.sex.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<pre><code>male      0.58875
female    0.41125
Name: sex, dtype: float64</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb138"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>meta_model.predict_proba(model_over[<span class="st">&#39;logreg&#39;</span>].coef_)</span></code></pre></div>
<pre><code>array([[0.27493777, 0.72506223]])</code></pre>
</div>
<p>On a donc un meta modèle qui ne dépends plus d’un <em>model extraction</em> et qui fonctionne bien. On va maintenant tracer pour différentes valeurs de <em>epsilon</em> et de <em>data_norm</em> les valeurs de prédiction du méta model et du recal.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb140"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gen_model_diff(epsilon<span class="op">=</span><span class="dv">1</span>, data_norm<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Pipeline(</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&#39;relations&#39;</span>, FunctionTransformer(add_relations)), </span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&#39;preprocession&#39;</span>, preprocessor_comb),</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>            <span class="co"># La seule différence avec model_over</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&#39;logreg&#39;</span>, diff.LogisticRegression(max_iter<span class="op">=</span><span class="dv">200</span>, epsilon<span class="op">=</span>epsilon, data_norm<span class="op">=</span>data_norm))</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb141"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mesure(model):</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    y_test_pred <span class="op">=</span> model.predict(X_test_secret)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_test_secret, y_test_pred)</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>    pred_homme <span class="op">=</span> meta_model.predict_proba(model[<span class="st">&#39;logreg&#39;</span>].coef_)[<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">0</span>])</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>    specificity <span class="op">=</span> cm[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">/</span>(cm[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">+</span>cm[<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">1</span>])<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">0</span>,<span class="dv">1</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">1</span>])</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> recall, specificity, precision, accuracy, pred_homme</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb142"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %%capture --no-display --no-stdout</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>new <span class="op">=</span> <span class="va">False</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> [<span class="st">&#39;recall&#39;</span>, <span class="st">&#39;specificity&#39;</span>, <span class="st">&#39;precision&#39;</span>, <span class="st">&#39;accuracy&#39;</span>, <span class="st">&#39;pred_homme&#39;</span>, <span class="st">&#39;eps&#39;</span>, <span class="st">&#39;data_norm&#39;</span>]</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> new:</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>    nb_test <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>    list_eps <span class="op">=</span> np.logspace(<span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">10</span>)</span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    list_data_norm <span class="op">=</span> np.logspace(<span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">10</span>)</span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>    X_secret <span class="op">=</span> data_fix_p_homme(<span class="fl">0.6</span>, <span class="dv">1000</span>)</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>    y_secret <span class="op">=</span> model_predict.predict(X_secret)</span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>    X_train_secret, X_test_secret, y_train_secret, y_test_secret <span class="op">=</span> model_selection.train_test_split(X_secret, </span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>                                                                                                    y_secret, </span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>                                                                                                    test_size<span class="op">=</span><span class="fl">0.20</span>)</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mesure(model):</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>        model.fit(X_train_secret, y_train_secret)</span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>        y_test_pred <span class="op">=</span> model.predict(X_test_secret)</span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>        cm <span class="op">=</span> confusion_matrix(y_test_secret, y_test_pred)</span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>        recall <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">0</span>])</span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>        specificity <span class="op">=</span> cm[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">/</span>(cm[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">+</span>cm[<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>        precision <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> (cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">1</span>])<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">0</span>,<span class="dv">1</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">0</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">1</span>])</span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>        pred_homme <span class="op">=</span> meta_model.predict_proba(model[<span class="st">&#39;logreg&#39;</span>].coef_)[<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> recall, specificity, precision, accuracy, pred_homme</span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>    all_mesures <span class="op">=</span> [(<span class="op">*</span>mesure(gen_model_diff(eps, data_norm)), eps, data_norm) <span class="cf">for</span> eps <span class="kw">in</span> tqdm(list_eps) </span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">for</span> data_norm <span class="kw">in</span> list_data_norm </span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(nb_test)]</span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a>    df_mesures <span class="op">=</span> pd.DataFrame(all_mesures, columns<span class="op">=</span>columns)</span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a>    np.save(<span class="st">&#39;data/privacy/data_mesures.npy&#39;</span>, df_mesures.to_numpy())</span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a>    df_mesures <span class="op">=</span> pd.DataFrame(np.load(<span class="st">&#39;data/privacy/data_mesures.npy&#39;</span>), columns<span class="op">=</span>columns)</span></code></pre></div>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="sourceCode" id="cb143"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
